name: Build SuperSteamPacker

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      
    - name: Restore NuGet packages
      run: nuget restore SuperSteamPacker.sln
      
    - name: Build solution
      run: msbuild SuperSteamPacker.sln /p:Configuration=Release /p:Platform="Any CPU"
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SuperSteamPacker-Build-${{ github.sha }}
        path: |
          bin/Release/
          !bin/Release/*.pdb
        retention-days: 30
        
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: SuperSteamPacker-exe-${{ github.sha }}
        path: bin/Release/SuperSteamPacker.exe
        retention-days: 90

    # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ»Ð¸Ð·Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ push Ð² main (Ð½Ðµ PR)
    - name: Create automatic release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        mkdir release-package
        copy bin\Release\SuperSteamPacker.exe release-package\
        copy bin\Release\*.dll release-package\
        copy bin\Release\*.config release-package\
        powershell Compress-Archive -Path release-package\* -DestinationPath SuperSteamPacker-auto-${{ github.run_number }}.zip
      
    - name: Generate release tag
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      id: release_tag
      run: |
        $date = Get-Date -Format "yyyy.MM.dd"
        $tag = "auto-v$date-build${{ github.run_number }}"
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "Generated tag: $tag"
      
    - name: Create GitHub Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_tag.outputs.tag }}
        name: "SuperSteamPacker Auto-Build #${{ github.run_number }}"
        files: |
          SuperSteamPacker-auto-${{ github.run_number }}.zip
          bin/Release/SuperSteamPacker.exe
        draft: false
        prerelease: false
        body: |
          ## ðŸ¤– Automatic Build #${{ github.run_number }}
          
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          **Commit:** ${{ github.sha }}
          **Message:** ${{ github.event.head_commit.message }}
          
          ### ðŸ“¦ Downloads
          - **SuperSteamPacker.exe** - Standalone executable  
          - **SuperSteamPacker-auto-${{ github.run_number }}.zip** - Full package with dependencies
          
          ### ðŸ”„ Changes
          ${{ github.event.head_commit.message }}
          
          ---
          *This is an automatic release created from the latest main branch.*
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 